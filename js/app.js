$(function(){function e(){var e=this,t=new gMaps(mapOptions,mapStyle),a=t.map,i=(t.infoWindow,t.getCurrentLocation()),r=t.marker_animation;e.nearByPlaces=ko.observableArray([]),e.showResults=ko.observable(!0),e.placeReviews=ko.observableArray([]),e.placePhotos=ko.observableArray([]),e.placeInFocus=ko.observable(),e.nytarticles=ko.observableArray([]),e.nytInFocus=ko.observable(),e.wikiarticles=ko.observableArray([]),e.wikiInFocus=ko.observable(),e.streetView=ko.observable(),e.noimage=ko.observable(),t.self=e;var s="http://api.nytimes.com/svc/search/v2/articlesearch.json?",o="befcd9ed183aa5edba4a379ed537e27f:10:73683129",n="http://en.wikipedia.org/w/api.php?action=opensearch&search=%data%&format=json&callback=wikiCallback",c="http://maps.googleapis.com/maps/api/streetview?";e.getAddress=function(e){if(e.vicinity){var t=e.vicinity.indexOf(",");return e.vicinity.slice(0,t)}return e.formatted_address},e.getLocality=function(e){var t=e.adr_address,a='class="locality">',i='class="country-name">',r=0,s={},o=t.indexOf(a),n=0,c=0,l=0;if(o&&(r=o+a.length,n=t.indexOf("</span>",r)),n&&(s.locality=t.slice(r,n),c=t.indexOf('class="country-name"',n)),c){r=c+i.length;var l=t.indexOf("</span>",r);s.country=t.slice(r,l)}return console.log(s),s},e.toggleResults=function(){1==e.showResults()?e.showResults(!1):e.showResults(!0)},e.icons=ko.computed(function(){var t=new Set,a=[];return e.nearByPlaces().forEach(function(e,a){a&&t.add(e.icon)}),t.forEach(function(e){a.push({icon:e})}),a.slice(0,19)}),e.rateStar=function(e){for(var t=Math.round(e),a=e-t,i=[],r=a>0?4-t:5-t,s=0;t>s;s++)i.push({star:"images/full-star.png"});for(a>0&&i.push({star:"images/half-star.png"}),s=0;r>s;s++)i.push({star:"images/empty-star.png"});return i},e.formattedType=function(e){var t=e.types[0].replace(/[_-]/g," ");return t.charAt(0).toUpperCase()+t.substr(1,t.length)},t.nearbySearch(i),t.initAutocomplete(),e.getWebsite=function(e){return e.website?e.website:""},e.clickMarker=function(e){var a=e.name.toLowerCase();t.markers.forEach(function(e){e.title.toLowerCase()===a&&google.maps.event.trigger(e,"click")})},e.getNytArticle=function(t){var a=e.getLocality(t),i=s,r=a.locality,n=a.country,c=[],l=$('script[data-template="nytimes"]').html();e.nytInFocus("about "+n+" "+r);var u=setTimeout(function(){c.push("<p>failed to query New York times resources</p>")},5e3);$.getJSON(i,{q:r,fq:n,page:0,sort:"newest",hl:!0,"api-key":o}).done(function(e){"OK"==e.status&&$.each(e.response.docs,function(e,t){var a=t.headline.main;null!=a?c.push(l.replace(/{{headline}}/,a).replace(/{{articleUrl}}/,t.web_url)):c.push(l.replace(/{{headline}}/,"There are no recents articles").replace(/{{articleUrl}}/,"#"))}),this.nytarticles(c),clearTimeout(u)}.bind(e)).fail(function(e){c.push("<p>New York Times Articles could bot be loaded</p>"),this.nytarticles(c)}.bind(e))},e.openSearchWikipedia=function(t){var a=e.getLocality(t),i=[],r=a.locality,s=n.replace("%data%",r),o="http://fr.wikipedia.org/wiki/",c=$('script[data-template="wiki"]').html();e.wikiInFocus("about "+r);var l=setTimeout(function(){i.push("<p>failed to query wiki resources</p>")},5e3);$.ajax({url:s,dataType:"jsonp"}).done(function(e){var t=e[1];$.each(t,function(e,t){var a=o+t;i.push(c.replace(/{{wikiarticle}}/,t).replace(/{{articleUrl}}/,a))}),this.wikiarticles(i),clearTimeout(l)}.bind(e)).fail(function(e){i.push("<p>wiki pages could not be found</p>"),this.wikiarticles(i)}.bind(e))},e.getStreetView=function(t){var a=c+"size=600x400&location="+t.formatted_address;return e.noimage="No image for "+t.formatted_address,a},$("#filters").on("click","button",function(){function e(e){return-1!=e.toLowerCase().indexOf(i.substring(0,4))?e:void 0}r=google.maps.Animation.DROP;var i=$(this).children("img").attr("src").split("/").slice(-1)[0].split("-").slice(0,1)[0];myCategories=mapPlaceTypes.filter(e),localStorage.myCategories=JSON.stringify(myCategories),t.nearbySearch(a.getCenter())}),$("#reset").on("click",function(){myCategories=[],localStorage.myCategories=JSON.stringify(myCategories),t.nearbySearch(a.getCenter())})}ko.applyBindings(new e),$("#hide").click(function(){var e="",t=$(this).children("span").attr("class");e="left"===t.slice(29)?t.replace("left","right"):t.replace("right","left"),$(this).siblings("div").animate({width:"toggle"},500),$(this).children("span").attr("class",e)})});
$(function(){function e(){function e(e){return{init:function(t,i,n,o,r){var a,s;a=function(t,n){n.keyCode===e&&i().call(this,t,n)},s=function(){return{keyup:a}},ko.bindingHandlers.event.init(t,s,n,o,r)}}}function t(e){var t=r.numberPhotos(),i=r.currentIndex(),n=(i+e)%t;0>n&&(n=t-1),r.currentPhoto(r.placePhotos()[n]),r.currentIndex(n)}function i(){var e=$(window).width();e>800?r.showResults(!0):r.showResults(!1)}var n=13,o=27;ko.bindingHandlers.enterKey=e(n),ko.bindingHandlers.escapeKey=e(o),ko.bindingHandlers.selectAndFocus={init:function(e,t,i,n){ko.bindingHandlers.hasFocus.init(e,t,i,n),ko.utils.registerEventHandler(e,"focus",function(){e.focus()})},update:function(e,t){ko.utils.unwrapObservable(t()),setTimeout(function(){ko.bindingHandlers.hasFocus.update(e,t)},0)}};var r=this,a=new gMaps(mapOptions,mapStyle),s=a.map,c=(a.infoWindow,a.getCurrentLocation()),l=a.marker_animation;r.nearByPlaces=ko.observableArray([]),r.showResults=ko.observable(!0),r.placeReviews=ko.observableArray([]),r.placePhotos=ko.observableArray([]),r.placeInFocus=ko.observable(),r.nytarticles=ko.observableArray([]),r.nytInFocus=ko.observable(),r.wikiarticles=ko.observableArray([]),r.wikiInFocus=ko.observable(),r.streetView=ko.observable(),r.noimage=ko.observable(),r.showView=ko.observable(!1),r.currentPhoto=ko.observable(),r.currentIndex=ko.observable(0),r.keyword=ko.observable(),a.self=r,r.okwiki=ko.computed(function(){return r.wikiarticles().length>0?!0:!1}),r.closeWiki=function(){r.wikiarticles([])},r.oknyt=ko.computed(function(){return r.nytarticles().length>0?!0:!1}),r.closeNyt=function(){r.nytarticles([])},r.okreview=ko.computed(function(){return r.placeReviews().length>0?!0:!1}),r.closeReview=function(){r.placeReviews([])},r.okphoto=ko.computed(function(){return r.placePhotos().length>0?!0:!1}),r.numberPhotos=ko.computed(function(){return r.placePhotos().length}),r.photoIndex=ko.computed(function(){return r.currentIndex()+1}),r.closePhoto=function(){r.placePhotos([]),r.currentIndex(0)};var u="http://api.nytimes.com/svc/search/v2/articlesearch.json?",d="befcd9ed183aa5edba4a379ed537e27f:10:73683129",p="http://en.wikipedia.org/w/api.php?action=opensearch&search=%data%&format=json&callback=wikiCallback",f="http://maps.googleapis.com/maps/api/streetview?";r.print=function(){var e=r.keyword().trim();console.log(e)},r.getAddress=function(e){if(e.vicinity){var t=e.vicinity.indexOf(",");return e.vicinity.slice(0,t)}return e.formatted_address},r.getLocality=function(e){console.log(e);var t=e.adr_address,i='class="locality">',n='class="country-name">',o='class="region">',r=0,a={},s=0;return idx1=t.indexOf(i),idx1>0&&(r=idx1+i.length,s=t.indexOf("</span>",r),a.locality=t.slice(r,s)),idx1=t.indexOf('class="region"',s+7),idx1>0&&(r=idx1+o.length,s=t.indexOf("</span>",r),a.region=t.slice(r,s)),idx1=t.indexOf('class="country-name"',s+7),idx1>0&&(r=idx1+n.length,s=t.indexOf("</span>",r),a.country=t.slice(r,s)),a},r.toggleResults=function(){1==r.showResults()?r.showResults(!1):r.showResults(!0)},r.icons=ko.computed(function(){var e=new Set,t=[];return r.nearByPlaces().forEach(function(t,i){i&&e.add(t.icon)}),e.forEach(function(e){t.push({icon:e})}),t.slice(0,19)}),r.rateStar=function(e){for(var t=Math.round(e),i=e-t,n=[],o=i>0?4-t:5-t,r=0;t>r;r++)n.push({star:"images/full-star.png"});for(i>0&&n.push({star:"images/half-star.png"}),r=0;o>r;r++)n.push({star:"images/empty-star.png"});return n},r.formattedType=function(e){var t=e.types[0].replace(/[_-]/g," ");return t.charAt(0).toUpperCase()+t.substr(1,t.length)},a.nearbySearch(c),a.initAutocomplete(),r.clickMarker=function(e){var t=e.name.toLowerCase();a.markers.forEach(function(e){e.title.toLowerCase()===t&&(google.maps.event.trigger(e,"click"),window.innerWidth<800&&r.showResults(!1))})},r.photoBackward=function(){t(-1)},r.photoForward=function(){t(1)},r.getNytArticle=function(e){r.nytarticles([]);var t=r.getLocality(e),i=u,n=t.locality+" ";t.region&&(n+=t.region);var o=t.country,a=[],s=$('script[data-template="nytimes"]').html();r.nytInFocus("about "+o+" "+n);var c=setTimeout(function(){a.push("<p>failed to query New York times resources</p>"),this.nytarticles(a)}.bind(r),5e3);$.getJSON(i,{q:n,fq:o,page:0,sort:"newest",hl:!0,"api-key":d}).done(function(e){"OK"==e.status&&(console.log(this,r),$.each(e.response.docs,function(e,t){var i=t.headline.main;null!=i&&a.push(s.replace(/{{headline}}/,i).replace(/{{articleUrl}}/,t.web_url))})),this.nytarticles(a),clearTimeout(c)}.bind(r)).fail(function(e){a.push("<p>New York Times Articles could bot be loaded</p>"),this.nytarticles(a)}.bind(r))},r.openSearchWikipedia=function(e){r.wikiarticles([]);var t=r.getLocality(e),i=[],n=t.locality+" ";t.region&&(n+=t.region);var o=p.replace("%data%",n),a="http://fr.wikipedia.org/wiki/",s=$('script[data-template="wiki"]').html();r.wikiInFocus("about "+n);var c=setTimeout(function(){i.push("<p>failed to query wiki resources</p>"),this.wikiarticles(i)},5e3);$.ajax({url:o,dataType:"jsonp"}).done(function(e){var t=e[1];$.each(t,function(e,t){var n=a+t;i.push(s.replace(/{{wikiarticle}}/,t).replace(/{{articleUrl}}/,n))}),this.wikiarticles(i),clearTimeout(c)}.bind(r)).fail(function(e){i.push("<p>Wiki could bot be loaded</p>"),this.wikiarticles(i)}.bind(r))},r.getStreetView=function(e){r.streetView(f+"size=600x400&location="+e.formatted_address),r.noimage="Sorry no image for "+e.formatted_address,r.showView(!0)},r.closeView=function(){r.showView(!1)},$(window).resize(function(){i()}),$("#filters").on("click","button",function(){function e(e){return-1!=e.toLowerCase().indexOf(t.substring(0,4))?e:void 0}l=google.maps.Animation.DROP;var t=$(this).children("img").attr("src").split("/").slice(-1)[0].split("-").slice(0,1)[0];myCategories=mapPlaceTypes.filter(e),localStorage.myCategories=JSON.stringify(myCategories),a.nearbySearch(s.getCenter())}),$("#reset").on("click",function(){myCategories=[],localStorage.myCategories=JSON.stringify(myCategories),a.nearbySearch(s.getCenter())})}ko.applyBindings(new e),$("#hide").click(function(){var e="",t=$(this).children("span").attr("class");e="left"===t.slice(29)?t.replace("left","right"):t.replace("right","left"),$(this).siblings("div").animate({width:"toggle"},500),$(this).children("span").attr("class",e)})});